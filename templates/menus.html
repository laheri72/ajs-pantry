{% extends "base.html" %}

{% block title %}Menus - Maskan Breakfast Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="fw-bold"><i class="fas fa-utensils text-teal me-2"></i>Menu Management</h2>
            <div class="text-muted">Schedule meals and assign them to teams for performance tracking.</div>
        </div>
        <div class="col-md-6 text-end">
            {% if current_user.role in ['admin', 'pantryHead'] %}
            <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#addMenuModal">
                <i class="fas fa-plus"></i> Schedule New Meal
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Menu List -->
    <div class="row">
        {% if not menus %}
        <div class="col-12 text-center py-5">
            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No menus scheduled yet.</h5>
        </div>
        {% endif %}
        
        {% for menu in menus %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="menu-card h-100">
                <div class="menu-header">
                    <h5 class="fw-bold mb-0">{{ menu.dish.name if menu.dish else menu.title }}</h5>
                    <div>
                        <span class="badge bg-teal">{{ menu.meal_type.title() }}</span>
                        <span class="badge bg-warning ms-1 text-dark">{{ menu.dish_type.title() }}</span>
                    </div>
                </div>
                <div class="menu-body">
                    <p class="mb-3 text-secondary">{{ menu.description or 'No description provided.' }}</p>
                    
                    <div class="d-flex flex-column gap-2 small">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-day text-teal me-2" style="width: 20px;"></i>
                            <span class="fw-bold">{{ menu.date.strftime('%A, %b %d, %Y') }}</span>
                        </div>
                        
                        {% if menu.assigned_team %}
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users text-teal me-2" style="width: 20px;"></i>
                            <span>Assigned to <strong>{% if menu.assigned_team.icon %}{{ menu.assigned_team.icon }} {% endif %}{{ menu.assigned_team.name }}</strong></span>
                        </div>
                        {% elif menu.assigned_to %}
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-teal me-2" style="width: 20px;"></i>
                            <span>Assigned to <strong>{{ menu.assigned_to.full_name or menu.assigned_to.username or menu.assigned_to.email }}</strong></span>
                        </div>
                        {% else %}
                        <div class="d-flex align-items-center text-muted">
                            <i class="fas fa-user-slash me-2" style="width: 20px;"></i>
                            <span>Unassigned</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if current_user.role in ['admin', 'pantryHead'] %}
                <div class="menu-actions">
                    <button class="btn btn-sm btn-outline-teal flex-grow-1">
                        <i class="fas fa-edit me-1"></i> Edit
                    </button>
                    <form action="{{ url_for('delete_menu', menu_id=menu.id) }}" method="POST" class="flex-grow-1" onsubmit="return confirm('Are you sure you want to delete this menu?')">
                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if current_user.role in ['admin', 'pantryHead'] %}
<!-- Add Menu Modal -->
<div class="modal fade" id="addMenuModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-calendar-plus me-2"></i>Schedule New Meal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Dish Selection -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dishSelect" class="form-label">Dish</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-utensils"></i></span>
                                    <select class="form-select" name="dish_id" id="dishSelect" required>
                                        <option value="">Select a dish...</option>
                                        {% for d in dishes %}
                                        <option value="{{ d.id }}">{{ d.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-text mt-2">
                                    New dish? <a href="#" id="showNewDishLink" class="text-teal text-decoration-none fw-bold">Add it to the catalog</a>
                                </div>
                                
                                <div class="mt-3 p-3 bg-light rounded d-none" id="newDishWrap">
                                    <label for="newDishName" class="form-label fw-bold">New Dish Identity</label>
                                    <input type="text" class="form-control mb-2" name="new_dish_name" id="newDishName" maxlength="120" placeholder="e.g. Aloo Paratha">
                                    <div class="small text-muted mb-2">This will create a permanent entry for tracking.</div>
                                    <a href="#" id="cancelNewDishLink" class="small text-danger text-decoration-none">Cancel and use existing</a>
                                </div>
                            </div>
                        </div>

                        <!-- Date and Type -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date" class="form-label">Meal Date</label>
                                <input type="date" class="form-control" name="date" value="{{ today.strftime('%Y-%m-%d') if today else '' }}" required>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Meal</label>
                                        <select class="form-select" name="meal_type">
                                            <option value="breakfast" selected>Breakfast</option>
                                            <option value="lunch">Lunch</option>
                                            <option value="dinner">Dinner</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" name="dish_type">
                                            <option value="main" selected>Main</option>
                                            <option value="side">Side</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="mb-3">
                                <label for="description" class="form-label">Description / Special Instructions</label>
                                <textarea class="form-control" name="description" rows="2" placeholder="e.g. Extra spicy, serve with chutney..."></textarea>
                            </div>
                        </div>

                        <!-- Assignment -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assigned_team_id" class="form-label text-teal fw-bold">Assign to Team (Room)</label>
                                <select class="form-select border-teal" id="assignedTeamSelect" name="assigned_team_id">
                                    <option value="">Select Team for performance...</option>
                                    {% for t in floor_teams %}
                                    <option value="{{ t.id }}">{% if t.icon %}{{ t.icon }} {% endif %}{{ t.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Highly recommended for evaluation tracking.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assigned_to_id" class="form-label">Assign to Individual</label>
                                <select class="form-select" id="assignedUserSelect" name="assigned_to_id">
                                    <option value="">Select individual...</option>
                                    {% for user in floor_users %}
                                    <option value="{{ user.id }}">{{ user.full_name or user.username or user.email }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-teal px-4">
                        <i class="fas fa-check-circle me-1"></i> Save Menu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.menu-card {
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.05);
}
.menu-header {
    background: var(--teal-lighter);
    color: var(--teal-dark);
    border-radius: 12px 12px 0 0;
    padding: 1.25rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const teamSelect = document.getElementById('assignedTeamSelect');
    const userSelect = document.getElementById('assignedUserSelect');
    const dishSelect = document.getElementById('dishSelect');
    const showNewDishLink = document.getElementById('showNewDishLink');
    const cancelNewDishLink = document.getElementById('cancelNewDishLink');
    const newDishWrap = document.getElementById('newDishWrap');
    const newDishName = document.getElementById('newDishName');

    if (teamSelect && userSelect) {
        function syncAssignmentSelects() {
            if (teamSelect.value) {
                userSelect.value = '';
                userSelect.disabled = true;
                userSelect.classList.add('bg-light');
            } else {
                userSelect.disabled = false;
                userSelect.classList.remove('bg-light');
            }
        }
        teamSelect.addEventListener('change', syncAssignmentSelects);
        syncAssignmentSelects();
    }

    if (showNewDishLink) {
        showNewDishLink.addEventListener('click', function (e) {
            e.preventDefault();
            dishSelect.value = '';
            dishSelect.required = false;
            dishSelect.disabled = true;
            newDishWrap.classList.remove('d-none');
            newDishName.required = true;
            newDishName.focus();
        });
    }

    if (cancelNewDishLink) {
        cancelNewDishLink.addEventListener('click', function (e) {
            e.preventDefault();
            dishSelect.disabled = false;
            dishSelect.required = true;
            newDishWrap.classList.add('d-none');
            newDishName.required = false;
            newDishName.value = '';
        });
    }
});
</script>
{% endblock %}

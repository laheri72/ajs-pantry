{% extends "base.html" %}

{% block title %}Calendar - Maskan Breakfast Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">Calendar - Floor {{ active_floor }}</h2>
            <p class="text-muted small mb-0">Manage and view floor activities</p>
        </div>
        <div class="d-flex gap-2">
            {% if current_user.role in ['admin', 'pantryHead'] %}
            <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#addEventModal">
                <i class="fas fa-plus me-1"></i>Special Event
            </button>
            {% endif %}
            <div class="btn-group">
                <button class="btn btn-outline-teal" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-teal fw-bold" id="currentMonth" style="min-width: 150px;"></button>
                <button class="btn btn-outline-teal" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-container">
        <div class="calendar-header">
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
        </div>
        <div class="calendar-body" id="calendarBody">
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-4">
        <div class="card legend-card border-0">
            <div class="card-body">
                <h6 class="fw-bold mb-3">Legend</h6>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color bg-teal"></span>
                        <span class="small">Menus</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color bg-warning"></span>
                        <span class="small">Tea Duty</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color bg-info"></span>
                        <span class="small">Special Events</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Event Details -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header text-white" id="modalHeader">
                <h5 class="modal-title" id="modalTitle">Event Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalDate" class="text-muted small mb-2"></div>
                <div id="modalDescription" class="mb-3"></div>
                <div id="modalMeta" class="p-3 bg-light rounded-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Adding Special Event -->
{% if current_user.role in ['admin', 'pantryHead'] %}
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-teal text-white">
                <h5 class="modal-title">Add Special Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('pantry.create_special_event') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" class="form-control" placeholder="e.g. Guest Visit, Cleaning Day" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" required id="newEventDate">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea name="description" class="form-control" rows="3" placeholder="Additional details about the event..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-teal px-4">Save Event</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
    .calendar-event {
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: transform 0.1s ease;
    }
    .calendar-event:hover {
        transform: scale(1.02);
        filter: brightness(0.9);
    }
    .calendar-day {
        position: relative;
    }
    .day-number {
        font-size: 0.9rem;
        color: var(--gray);
    }
    .calendar-day.today .day-number {
        color: var(--teal-dark);
        font-weight: 800;
    }
    .calendar-event.bg-warning {
        color: #000 !important;
    }
</style>

<script>
let currentDate = new Date();
const menus = {{ menus | tojson }};
const teaTasks = {{ tea_tasks | tojson }};
const specialEvents = {{ special_events | tojson }};

function showEventDetail(type, data) {
    const modalElement = document.getElementById('eventDetailModal');
    const header = document.getElementById('modalHeader');
    const title = document.getElementById('modalTitle');
    const date = document.getElementById('modalDate');
    const desc = document.getElementById('modalDescription');
    const meta = document.getElementById('modalMeta');

    // Reset classes
    header.className = 'modal-header text-white';
    
    date.textContent = new Date(data.date).toLocaleDateString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });

    if (type === 'menu') {
        header.classList.add('bg-teal');
        title.textContent = data.title;
        desc.textContent = data.description || 'No description provided.';
        meta.innerHTML = `
            <div class="d-flex flex-column gap-2">
                <div class="small"><i class="fas fa-utensils me-2 text-teal"></i><strong>Dish Type:</strong> ${data.dish_type.charAt(0).toUpperCase() + data.dish_type.slice(1)}</div>
                <div class="small"><i class="fas fa-clock me-2 text-teal"></i><strong>Meal:</strong> ${data.meal_type.charAt(0).toUpperCase() + data.meal_type.slice(1)}</div>
                <div class="small"><i class="fas fa-user me-2 text-teal"></i><strong>Assigned:</strong> ${data.assigned_to_label || 'Unassigned'}</div>
            </div>
        `;
    } else if (type === 'tea') {
        header.classList.add('bg-warning');
        header.classList.remove('text-white');
        header.classList.add('text-dark');
        title.textContent = 'Tea Duty';
        desc.textContent = 'Scheduled tea preparation and service duty.';
        meta.innerHTML = `
            <div class="d-flex flex-column gap-2">
                <div class="small"><i class="fas fa-user me-2 text-warning"></i><strong>Assigned:</strong> ${data.assigned_to_name || 'Unassigned'}</div>
                <div class="small"><i class="fas fa-check-circle me-2 text-warning"></i><strong>Status:</strong> ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}</div>
            </div>
        `;
    } else if (type === 'special') {
        header.classList.add('bg-info');
        title.textContent = data.title;
        desc.textContent = data.description || 'No additional details.';
        meta.innerHTML = `
            <div class="d-flex flex-column gap-2">
                <div class="small"><i class="fas fa-user-shield me-2 text-info"></i><strong>Created by:</strong> ${data.created_by}</div>
            </div>
        `;
    }

    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';

    for (let week = 0; week < 6; week++) {
        const weekRow = document.createElement('div');
        weekRow.className = 'calendar-week';

        for (let day = 0; day < 7; day++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + (week * 7) + day);

            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';

            if (currentDay.getMonth() !== month) {
                dayCell.classList.add('other-month');
            }

            if (currentDay.toDateString() === new Date().toDateString()) {
                dayCell.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = currentDay.getDate();
            dayCell.appendChild(dayNumber);

            const dateStr = currentDay.toISOString().split('T')[0];

            // Render Menus
            menus.filter(m => m.date === dateStr).forEach(menu => {
                const event = document.createElement('div');
                event.className = 'calendar-event bg-teal';
                event.textContent = menu.title;
                event.onclick = (e) => { e.stopPropagation(); showEventDetail('menu', menu); };
                dayCell.appendChild(event);
            });

            // Render Tea Tasks
            teaTasks.filter(t => t.date === dateStr).forEach(task => {
                const event = document.createElement('div');
                event.className = 'calendar-event bg-warning';
                event.textContent = 'Tea: ' + (task.assigned_to_name ? task.assigned_to_name.split(' ')[0] : 'Unassigned');
                event.onclick = (e) => { e.stopPropagation(); showEventDetail('tea', task); };
                dayCell.appendChild(event);
            });

            // Render Special Events
            specialEvents.filter(s => s.date === dateStr).forEach(special => {
                const event = document.createElement('div');
                event.className = 'calendar-event bg-info';
                event.textContent = special.title;
                event.onclick = (e) => { e.stopPropagation(); showEventDetail('special', special); };
                dayCell.appendChild(event);
            });

            {% if current_user.role in ['admin', 'pantryHead'] %}
            dayCell.onclick = () => {
                document.getElementById('newEventDate').value = dateStr;
                const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
                modal.show();
            };
            dayCell.style.cursor = 'pointer';
            {% endif %}

            weekRow.appendChild(dayCell);
        }

        calendarBody.appendChild(weekRow);
    }

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

document.addEventListener('DOMContentLoaded', function() {
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
});
</script>
{% endblock %}

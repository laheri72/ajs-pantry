{% extends "base.html" %}

{% block title %}Admin Dashboard - Maskan Breakfast Management{% endblock %}

{% block content %}
<div class="container-fluid dashboard-page">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="fw-bold text-teal-dark"><i class="fas fa-shield-alt me-2"></i>System Administration</h2>
            <p class="text-muted">Holistic overview and management across all 11 floors.</p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="btn-group">
                <button class="btn btn-teal shadow-sm" data-bs-toggle="modal" data-bs-target="#bulkAddModal">
                    <i class="fas fa-users-cog me-1"></i> Bulk Onboard Members
                </button>
                <button class="btn btn-outline-teal shadow-sm ms-2" data-bs-toggle="modal" data-bs-target="#addPantryHeadModal">
                    <i class="fas fa-user-tie me-1"></i> Assign Pantry Head
                </button>
            </div>
        </div>
    </div>

    <!-- Holistic System Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-teal h-100">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <p class="small text-uppercase fw-bold mb-0 opacity-75">Total Population</p>
                    <h3 class="fw-bold">{{ total_users }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-primary h-100">
                <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                <div class="stat-content">
                    <p class="small text-uppercase fw-bold mb-0 opacity-75">Total Budget (All Floors)</p>
                    <h3 class="fw-bold">&#8377;{{ "%.0f"|format(total_budget_all) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-danger h-100">
                <div class="stat-icon"><i class="fas fa-shopping-basket"></i></div>
                <div class="stat-content">
                    <p class="small text-uppercase fw-bold mb-0 opacity-75">Cumulative Spending</p>
                    <h3 class="fw-bold">&#8377;{{ "%.0f"|format(total_spent_all) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning h-100 text-white">
                <div class="stat-icon"><i class="fas fa-star"></i></div>
                <div class="stat-content">
                    <p class="small text-uppercase fw-bold mb-0 opacity-75">Avg System Satisfaction</p>
                    <h3 class="fw-bold">{{ system_avg_rating }}/5.0</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Floor-wise Analytics Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-teal"><i class="fas fa-chart-line me-2"></i>Floor Performance Analytics</h5>
                    <span class="badge bg-teal-light text-teal">Real-time Data</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 text-center">
                            <thead class="bg-light">
                                <tr>
                                    <th>Floor</th>
                                    <th>Pantry Head</th>
                                    <th>Members</th>
                                    <th>Budget Allocation</th>
                                    <th>Total Spent</th>
                                    <th>Balance</th>
                                    <th>Satisfaction</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in floor_data %}
                                <tr>
                                    <td class="fw-bold">Floor {{ f.floor }}</td>
                                    <td class="text-start">
                                        {% if f.pantry_head != 'Not Assigned' %}
                                        <i class="fas fa-user-circle text-teal me-1"></i> {{ f.pantry_head }}
                                        {% else %}
                                        <span class="text-muted italic small">Vacant</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ f.user_count }}</td>
                                    <td class="text-success fw-bold">&#8377;{{ "%.2f"|format(f.budget) }}</td>
                                    <td class="text-danger">&#8377;{{ "%.2f"|format(f.spent) }}</td>
                                    <td>
                                        <span class="badge {% if f.remaining < 0 %}bg-danger{% else %}bg-success-light text-success{% endif %}">
                                            &#8377;{{ "%.2f"|format(f.remaining) }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-center gap-1">
                                            <span class="fw-bold">{{ f.avg_rating }}</span>
                                            <i class="fas fa-star text-warning small"></i>
                                        </div>
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin_panel.set_active_floor') }}">
                                            <input type="hidden" name="floor" value="{{ f.floor }}">
                                            <button type="submit" class="btn btn-sm btn-outline-teal">
                                                Switch View
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-teal"><i class="fas fa-users-cog me-2"></i>Member Directory</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="memberSearch" class="form-control form-control-sm" placeholder="Search TR or Name..." style="width: 200px;">
                        <button class="btn btn-sm btn-teal" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0" id="usersTable">
                            <thead class="bg-light sticky-top">
                                <tr>
                                    <th>TR Number</th>
                                    <th>Member Name</th>
                                    <th>Role</th>
                                    <th>Floor</th>
                                    <th>Status</th>
                                    <th class="text-end">Management</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for admin_user in all_users %}
                                <tr class="user-row" data-search="{{ admin_user.tr_number }} {{ admin_user.full_name }} {{ admin_user.email }}">
                                    <td class="fw-bold text-teal">{{ admin_user.tr_number or 'N/A' }}</td>
                                    <td>
                                        <div class="fw-bold">{{ admin_user.full_name or 'New Member' }}</div>
                                        <div class="small text-muted">{{ admin_user.email }}</div>
                                    </td>
                                    <td>
                                        <span class="badge {% if admin_user.role == 'admin' %}bg-dark{% elif admin_user.role == 'pantryHead' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ admin_user.role }}
                                        </span>
                                    </td>
                                    <td><span class="badge bg-teal-light text-teal">Floor {{ admin_user.floor }}</span></td>
                                    <td>
                                        {% if admin_user.is_first_login %}
                                        <span class="badge bg-warning-light text-warning">Pending Login</span>
                                        {% else %}
                                        <span class="badge bg-success-light text-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if admin_user.id != current_user.id %}
                                        <form action="{{ url_for('admin_panel.admin') }}" method="POST" class="d-inline" onsubmit="return confirm('Permanently delete this user?')">
                                            <input type="hidden" name="action" value="delete_user">
                                            <input type="hidden" name="user_id" value="{{ admin_user.id }}">
                                            <button type="submit" class="btn btn-sm btn-link text-danger"><i class="fas fa-user-minus"></i></button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal (Single) -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-teal text-white">
                <h5 class="modal-title fw-bold">Add Single Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="add_user">
                    <input type="hidden" name="role" value="member">
                    <div class="mb-3">
                        <label class="form-label fw-bold">TR Number</label>
                        <input type="text" class="form-control shadow-none" name="tr_number" required placeholder="Ex: 25687">
                        <small class="text-muted">Email generated automatically.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Assigned Floor</label>
                        <select class="form-select shadow-none" name="floor" required>
                            {% for i in floor_options %}<option value="{{ i }}">Floor {{ i }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-teal">Create Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-users-cog me-2"></i>Bulk Member Onboarding</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="bulk_add_users">
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i> Paste multiple TR numbers separated by <strong>newlines</strong> or <strong>commas</strong>.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Target Floor</label>
                        <select class="form-select mb-3" name="floor" required>
                            <option value="" selected disabled>Select floor for this batch...</option>
                            {% for i in floor_options %}<option value="{{ i }}">Floor {{ i }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">TR Number List</label>
                        <textarea class="form-control" name="tr_list" rows="10" required placeholder="Paste list here...
Example:
25687
25688
25689, 25690"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Start Bulk Onboarding</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Pantry Head Modal -->
<div class="modal fade" id="addPantryHeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Promote to Pantry Head</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="assign_role">
                    <input type="hidden" name="role" value="pantryHead">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Target Floor</label>
                        <select class="form-select" name="floor" id="pantryHeadFloorSelect" required>
                            <option value="" selected disabled>Select floor...</option>
                            {% for i in floor_options %}<option value="{{ i }}">Floor {{ i }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Select Member</label>
                        <select class="form-select" name="user_id" id="pantryHeadUserSelect" required disabled>
                            <option value="">Select floor first</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Assign as PH</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .bg-success-light { background-color: #e8f5e9; }
    .bg-warning-light { background-color: #fff3e0; }
    .btn-outline-teal { color: var(--teal-primary); border-color: var(--teal-primary); }
    .btn-outline-teal:hover { background-color: var(--teal-primary); color: white; }
    .user-row:hover { background-color: rgba(38, 166, 154, 0.03); }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Member Search Logic
        const searchInput = document.getElementById('memberSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.user-row').forEach(row => {
                    const content = row.getAttribute('data-search').toLowerCase();
                    row.style.display = content.includes(term) ? '' : 'none';
                });
            });
        }

        // Dynamic Member Loading for Role Modal
        async function loadFloorMembers(floor, userSelect) {
            userSelect.disabled = true;
            userSelect.innerHTML = '<option value="">Loading members...</option>';

            try {
                const res = await fetch(`/admin/floor-members?floor=${encodeURIComponent(floor)}`, {
                    headers: { 'Accept': 'application/json' }
                });
                const data = await res.json();
                const members = data.members || [];

                if (!members.length) {
                    userSelect.innerHTML = '<option value="">No members available</option>';
                    return;
                }

                userSelect.innerHTML = '<option value="" selected disabled>Select member...</option>' + 
                    members.map(m => `<option value="${m.id}">${m.label}</option>`).join('');
                userSelect.disabled = false;
            } catch (e) {
                userSelect.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        const phFloorSelect = document.getElementById('pantryHeadFloorSelect');
        const phUserSelect = document.getElementById('pantryHeadUserSelect');
        if (phFloorSelect && phUserSelect) {
            phFloorSelect.addEventListener('change', () => loadFloorMembers(phFloorSelect.value, phUserSelect));
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Expenses & Budget - Maskan Breakfast Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 d-print-none">
        <div class="col-md-6">
            <h2 class="fw-bold"><i class="fas fa-money-bill-wave text-teal me-2"></i>Financial Ledger</h2>
            <div class="text-muted">Track floor budget allocations and spending against procurement.</div>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-outline-teal me-2" data-bs-toggle="modal" data-bs-target="#printConfigModal">
                <i class="fas fa-print"></i> Print Report
            </button>
            {% if is_manager %}
            <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#addBudgetModal">
                <i class="fas fa-plus"></i> Allocate Budget
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Financial Summary Cards -->
    <div class="row g-3 mb-4 d-print-none">
        <div class="col-md-4">
            <div class="stat-card bg-primary h-100">
                <div class="stat-content">
                    <p class="text-uppercase small fw-bold mb-1 opacity-75">Allocated Budget</p>
                    <h3 class="fw-bold mb-0">&#8377;{{ "%.2f"|format(total_budget) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card bg-danger h-100">
                <div class="stat-content">
                    <p class="text-uppercase small fw-bold mb-1 opacity-75">Total Spent</p>
                    <h3 class="fw-bold mb-0">&#8377;{{ "%.2f"|format(total_spent) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card {% if remaining_balance < 0 %}bg-danger{% else %}bg-success{% endif %} h-100 position-relative">
                <div class="stat-content">
                    <p class="text-uppercase small fw-bold mb-1 opacity-75">Remaining Balance</p>
                    <h3 class="fw-bold mb-0">&#8377;{{ "%.2f"|format(remaining_balance) }}</h3>
                </div>
                {% if remaining_balance < 0 %}
                <div class="position-absolute top-0 end-0 p-2">
                    <i class="fas fa-exclamation-triangle text-white animate-pulse"></i>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row d-print-none">
        <!-- Procurement Ledger -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-teal"><i class="fas fa-shopping-cart me-2"></i>Procurement Expense Ledger</h5>
                    <div>
                        <ul class="nav nav-pills nav-sm" id="ledgerTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active py-1" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-pane" type="button" role="tab">Pending</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1" id="recorded-tab" data-bs-toggle="tab" data-bs-target="#recorded-pane" type="button" role="tab">Recorded</button>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content">
                        <!-- Pending Costs Tab -->
                        <div class="tab-pane fade show active" id="pending-pane" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Item & Qty</th>
                                            <th>Date Completed</th>
                                            <th class="text-end">Actual Cost (&#8377;)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set pending_count = namespace(value=0) %}
                                        {% for item in completed_procurements %}
                                            {% if not item.actual_cost or item.actual_cost == 0 %}
                                                {% set pending_count.value = pending_count.value + 1 %}
                                                <tr>
                                                    <td>
                                                        <div class="fw-bold">{{ item.item_name }}</div>
                                                        <div class="small text-muted">{{ item.quantity }} &bull; {{ item.category }}</div>
                                                    </td>
                                                    <td>{{ item.created_at.strftime('%b %d, %Y') }}</td>
                                                    <td class="text-end">
                                                        {% if is_manager %}
                                                        <form method="POST" action="{{ url_for('expenses') }}" class="d-flex justify-content-end gap-2">
                                                            <input type="hidden" name="action" value="record_cost">
                                                            <input type="hidden" name="item_id" value="{{ item.id }}">
                                                            <input type="number" step="0.01" name="actual_cost" class="form-control form-control-sm text-end" placeholder="0.00" style="width: 100px;" required>
                                                            <button type="submit" class="btn btn-sm btn-teal"><i class="fas fa-save"></i></button>
                                                        </form>
                                                        {% else %}
                                                        <span class="text-muted italic">Not recorded</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        {% if pending_count.value == 0 %}
                                        <tr>
                                            <td colspan="3" class="text-center py-4 text-muted">No pending costs to record.</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Recorded Costs Tab -->
                        <div class="tab-pane fade" id="recorded-pane" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Item & Qty</th>
                                            <th>Date Completed</th>
                                            <th class="text-end">Actual Cost (&#8377;)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% set recorded_count = namespace(value=0) %}
                                        {% for item in completed_procurements %}
                                            {% if item.actual_cost and item.actual_cost > 0 %}
                                                {% set recorded_count.value = recorded_count.value + 1 %}
                                                <tr>
                                                    <td>
                                                        <div class="fw-bold">{{ item.item_name }}</div>
                                                        <div class="small text-muted">{{ item.quantity }} &bull; {{ item.category }}</div>
                                                    </td>
                                                    <td>{{ item.created_at.strftime('%b %d, %Y') }}</td>
                                                    <td class="text-end fw-bold text-teal">
                                                        {% if is_manager %}
                                                        <div class="d-flex justify-content-end align-items-center gap-2">
                                                            <span>&#8377;{{ "%.2f"|format(item.actual_cost) }}</span>
                                                            <button class="btn btn-sm btn-link p-0 text-muted" onclick="enableEditCost(this, {{ item.id }}, '{{ item.actual_cost }}')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                        {% else %}
                                                        &#8377;{{ "%.2f"|format(item.actual_cost) }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        {% if recorded_count.value == 0 %}
                                        <tr>
                                            <td colspan="3" class="text-center py-4 text-muted">No recorded costs yet.</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Budget History & Legacy -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-history me-2 text-teal"></i>Budget Timeline</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for b in budgets %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="badge bg-teal-light text-teal">{{ b.allocation_type.title() }}</span>
                                <span class="fw-bold text-success">+&#8377;{{ b.amount_allocated }}</span>
                            </div>
                            <div class="small text-muted">
                                From {{ b.start_date.strftime('%b %d') }} {% if b.end_date %}to {{ b.end_date.strftime('%b %d') }}{% endif %}
                            </div>
                            {% if b.notes %}
                            <div class="small italic text-muted mt-1">"{{ b.notes }}"</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if not budgets %}
                        <div class="p-3 text-center text-muted">No budget history yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if legacy_expenses %}
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-2">
                    <div class="small fw-bold text-muted text-uppercase">Legacy Expenses (History)</div>
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <div class="list-group list-group-flush">
                        {% for e in legacy_expenses %}
                        <div class="list-group-item small">
                            <div class="d-flex justify-content-between">
                                <span>{{ e.description }}</span>
                                <span class="text-danger">-&#8377;{{ e.amount }}</span>
                            </div>
                            <div class="text-muted">{{ e.date.strftime('%Y-%m-%d') }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if is_manager %}
<!-- Add Budget Modal -->
<div class="modal fade" id="addBudgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Allocate Budget (Floor {{ active_floor }})</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_budget') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Amount Allocated (&#8377;)</label>
                        <input type="number" step="0.01" name="amount" class="form-control" required placeholder="0.00">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Allocation Type</label>
                                <select class="form-select" name="allocation_type" required>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="15days">Every 15 Days</option>
                                    <option value="manual" selected>Manual / Ad-hoc</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" name="start_date" class="form-control" value="{{ today.strftime('%Y-%m-%d') if today else '' }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date (Optional)</label>
                        <input type="date" name="end_date" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="e.g. Funding for upcoming event..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-teal">Add Allocation</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Print Configuration Modal -->
<div class="modal fade" id="printConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-print me-2"></i>Configure Print Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label fw-bold">1. Adjust Budget for this Report</label>
                    <div class="input-group">
                        <span class="input-group-text">&#8377;</span>
                        <input type="number" step="0.01" class="form-control" id="printBudgetInput" value="{{ "%.2f"|format(total_budget) }}">
                    </div>
                    <div class="form-text">This will only affect the printed PDF, not the database.</div>
                </div>

                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <label class="form-label fw-bold mb-0">2. Select Recorded Expenses to Include</label>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="selectAllPrintItems(true)">Select All</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="selectAllPrintItems(false)">Deselect All</button>
                    </div>
                </div>

                <div class="table-responsive border rounded" style="max-height: 400px;">
                    <table class="table table-sm table-hover mb-0" id="printSelectionTable">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Date</th>
                                <th>Item / Description</th>
                                <th>Qty</th>
                                <th class="text-end">Amount (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Procurement Items -->
                            {% for item in completed_procurements %}
                                {% if item.actual_cost and item.actual_cost > 0 %}
                                <tr onclick="toggleRowCheck(this)">
                                    <td class="text-center">
                                        <input type="checkbox" class="print-item-check" checked 
                                               data-date="{{ item.created_at.strftime('%Y-%m-%d') }}"
                                               data-desc="{{ item.item_name }}"
                                               data-qty="{{ item.quantity }}"
                                               data-amount="{{ item.actual_cost }}">
                                    </td>
                                    <td>{{ item.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ item.item_name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td class="text-end fw-bold text-teal">{{ "%.2f"|format(item.actual_cost) }}</td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                            
                            <!-- Legacy Expenses -->
                            {% for e in legacy_expenses %}
                            <tr onclick="toggleRowCheck(this)">
                                <td class="text-center">
                                    <input type="checkbox" class="print-item-check" checked 
                                           data-date="{{ e.date.strftime('%Y-%m-%d') }}"
                                           data-desc="{{ e.description }}"
                                           data-qty="-"
                                           data-amount="{{ e.amount }}">
                                </td>
                                <td>{{ e.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ e.description }}</td>
                                <td>-</td>
                                <td class="text-end fw-bold text-danger">{{ "%.2f"|format(e.amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light d-flex justify-content-between">
                <div id="printSummaryPreview" class="small fw-bold text-teal">
                    Selected: 0 items | Total: ₹0.00
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-teal px-4" onclick="generateCustomPrintReport()">
                        <i class="fas fa-file-pdf me-2"></i>Generate PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Original Printable Report (Hidden) -->
<div id="printableReportTemplate" style="display: none;">
    <div class="print-header text-center mb-4">
        <h2 class="fw-bold" style="color: #00695c;">AJS Pantry - Floor <span id="printFloorVal">{{ active_floor }}</span></h2>
        <h3>Monthly Expense Report</h3>
        <p>Generated on: {{ today.strftime('%Y-%m-%d') if today else '' }}</p>
    </div>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Item / Description</th>
                <th>Quantity</th>
                <th class="text-end">Amount (₹)</th>
            </tr>
        </thead>
        <tbody id="printReportBody">
            <!-- Dynamically populated -->
        </tbody>
        <tfoot id="printReportFooter">
            <!-- Dynamically populated -->
        </tfoot>
    </table>
    <div class="mt-4 small text-muted text-center border-top pt-2">
        This is a computer-generated report for AJS Pantry Management System.
    </div>
</div>

<script>
function selectAllPrintItems(checked) {
    document.querySelectorAll('.print-item-check').forEach(cb => {
        cb.checked = checked;
    });
    updatePrintSummary();
}

function toggleRowCheck(row) {
    const cb = row.querySelector('.print-item-check');
    if (cb) {
        cb.checked = !cb.checked;
        updatePrintSummary();
    }
}

function updatePrintSummary() {
    let count = 0;
    let total = 0;
    document.querySelectorAll('.print-item-check:checked').forEach(cb => {
        count++;
        total += parseFloat(cb.getAttribute('data-amount') || 0);
    });
    document.getElementById('printSummaryPreview').innerText = `Selected: ${count} items | Total: ₹${total.toFixed(2)}`;
}

// Initial summary call
document.addEventListener('DOMContentLoaded', () => {
    updatePrintSummary();
    // Prevent row toggle when clicking checkbox directly
    document.querySelectorAll('.print-item-check').forEach(cb => {
        cb.onclick = (e) => e.stopPropagation();
        cb.onchange = updatePrintSummary;
    });
});

function generateCustomPrintReport() {
    const customBudget = parseFloat(document.getElementById('printBudgetInput').value || 0);
    const selectedItems = [];
    let totalSpent = 0;

    document.querySelectorAll('.print-item-check:checked').forEach(cb => {
        const amt = parseFloat(cb.getAttribute('data-amount') || 0);
        selectedItems.push({
            date: cb.getAttribute('data-date'),
            desc: cb.getAttribute('data-desc'),
            qty: cb.getAttribute('data-qty'),
            amount: amt
        });
        totalSpent += amt;
    });

    if (selectedItems.length === 0) {
        alert('Please select at least one record to print.');
        return;
    }

    const remaining = customBudget - totalSpent;
    
    // Build the table rows
    let rowsHtml = '';
    selectedItems.forEach(item => {
        rowsHtml += `
            <tr>
                <td>${item.date}</td>
                <td>${item.desc}</td>
                <td>${item.qty}</td>
                <td class="text-end">₹${item.amount.toFixed(2)}</td>
            </tr>
        `;
    });

    // Build the footer
    const footerHtml = `
        <tr class="table-secondary fw-bold">
            <td colspan="3">Report Budget Allocation</td>
            <td class="text-end">₹${customBudget.toFixed(2)}</td>
        </tr>
        <tr class="table-warning fw-bold">
            <td colspan="3">Total Spent (Selected)</td>
            <td class="text-end">₹${totalSpent.toFixed(2)}</td>
        </tr>
        <tr class="${remaining < 0 ? 'table-danger' : 'table-success'} fw-bold">
            <td colspan="3">Balance</td>
            <td class="text-end">₹${remaining.toFixed(2)}</td>
        </tr>
    `;

    // Populate the template
    const printTemplate = document.getElementById('printableReportTemplate').cloneNode(true);
    printTemplate.style.display = 'block';
    printTemplate.querySelector('#printReportBody').innerHTML = rowsHtml;
    printTemplate.querySelector('#printReportFooter').innerHTML = footerHtml;

    // Open print window
    const w = window.open('', '_blank', 'width=900,height=750');
    if (!w) return;

    w.document.open();
    w.document.write(`
        <!doctype html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>AJS Pantry Expense Report</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 30px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                .table th { background-color: #f8f9fa !important; color: #00695c !important; }
                .print-header h2 { color: #00695c; }
                @media print {
                    .table-secondary { background-color: #e2e3e5 !important; -webkit-print-color-adjust: exact; }
                    .table-warning { background-color: #fff3cd !important; -webkit-print-color-adjust: exact; }
                    .table-success { background-color: #d4edda !important; -webkit-print-color-adjust: exact; }
                    .table-danger { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; }
                }
            </style>
        </head>
        <body>
            ${printTemplate.innerHTML}
        </body>
        </html>
    `);
    w.document.close();

    w.focus();
    setTimeout(() => {
        w.print();
        w.close();
    }, 500);
}

function enableEditCost(btn, itemId, currentCost) {
    const td = btn.closest('td');
    td.innerHTML = `
        <form method="POST" action="{{ url_for('expenses') }}" class="d-flex justify-content-end gap-2">
            <input type="hidden" name="action" value="record_cost">
            <input type="hidden" name="item_id" value="${itemId}">
            <input type="number" step="0.01" name="actual_cost" class="form-control form-control-sm text-end" value="${currentCost}" style="width: 100px;" required>
            <button type="submit" class="btn btn-sm btn-teal"><i class="fas fa-save"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="fas fa-times"></i></button>
        </form>
    `;
}
</script>
{% endblock %}
